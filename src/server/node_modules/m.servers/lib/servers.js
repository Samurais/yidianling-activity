
const request = require('request');
const defRequestHeader = require('m.config').requestHeader;
const config = require('m.config');
const baseUrl = config.servers[config.G.env];

const get = (url) => (data = {}) => {

  let params = Object.keys(data).map(function (key) {
    return encodeURIComponent(key) + "=" + encodeURIComponent(data[key]);
  }).join("&");

  let reqUrl = `${baseUrl}${url}?${params}`;

  // 进入请求
  log.info(reqUrl);

  return new Promise((resolve, reject) => {
    request(reqUrl, function (error, response, body) {

      if (!error && response.statusCode == 200) {

        // 进入返回日志
        log.debug(body);

        let d = Object.assign({}, {"data": body}, {code: 0});
        resolve(d);
      } else {

        // 进入错误日志
        log.error(error);

        let d = Object.assign({}, {"data": error}, {code: -2});
        resolve(d);
        //reject(error);
      }
    });
  });
}

const post = (url) => (data = {}) => {

  let requestHeader = Object.assign({}, defRequestHeader);
      requestHeader.url = baseUrl+url;

  // 进入请求
  log.info(requestHeader);

  return new Promise((resolve, reject) => {

    request.post(requestHeader, function(error, response, body){

      if(!error) {

        // 进入返回日志
        log.debug(body);

        let d = Object.assign({}, {"data": body}, {code: 0});
        resolve(d);
      } else {

        // 进入错误日志
        log.error(error);
        let d = Object.assign({}, {"data": error}, {code: -2});
        resolve(d);
        //reject(d);
      }
    }).json(data);
  });
}

module.exports = {
  get,
  post,
};
