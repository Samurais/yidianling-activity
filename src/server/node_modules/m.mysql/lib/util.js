
const configData = require("../config");

module.exports = {

  // 设置创建表字段
  createTableData(name) {

    let str = `id INT UNSIGNED AUTO_INCREMENT,`;
    let data = configData.tableFields[name];

    for(let a in data) {

      let r = data[a];

      str += ` ${a} ${r.type}(${r.limit}) ${r.status} `;

      if(r.unique) {
        str += ` unique `;
      }

      str += ` , `;

      if(r.index) {
        str += ` INDEX ${a} (${a}), `;
      }
    }

    str += `PRIMARY KEY (id)`;

    return str;
  },

  // 设置添加表字段
  alterAddTable(data){
    let str = "";

    data.data.map((item, index) => {
      str += `ALTER TABLE ${data.tableName} ADD ${item.name} ${item.type}(${item.limit}) ${item.status};`;

      if(item.unique) {
        str += `ALTER TABLE ${data.tableName} ADD unique ${item.name}(${item.name});`;
      }

      if(item.index) {
        str += `ALTER TABLE ${data.tableName} ADD INDEX ${item.name}(${item.name});`;
      }
    });

    return str;
  },

  // 插入表数据
  insertTableData(connection, data){
    let str = "";

    data.data.map((item, index) => {

      let keys = [];
      let values = [];

      for(let a in item) {
        keys.push(a);
        values.push(`${connection.escape(item[a])}`);
      }

      str += `
        INSERT INTO ${data.tableName}
        (${keys.join()})
        values
        (${values.join()});
      `;
    });

    return str;
  },

  // 更新表数据
  updateTableData(connection, data){

    let str = ` UPDATE ${data.tableName} SET `;

    let d = data.data;
    let w = data.where;

    // 判断更新字段数据类型
    if(typeof d == "object") {
      let r = [];

      for(let a in d) {
        r.push(`${a}=${connection.escape(d[a])}`);
      }

      str += ` ${r.join()} `;
    }

    if(typeof d == "string") {
      str += ` ${d} `;
    }

    // 判断搜索条件字段类型
    if(typeof w == "string" && w != "") {

      // 为避免操作失误导致系统性的数据库删除。必须指定键值对。
      let wr = w.toLowerCase().split("or");
      let f = true;

      for(let i=0, l=wr.length; i<l; i++) {
        if(wr[i].indexOf("=") < 0) {
          log.error("检测到有危险性操作，系统拒绝执行命名。 请配置好键值对更新数据库。");
          console.log("检测到有危险性操作，系统拒绝执行命名。 请配置好键值对更新数据库。");
          f = false;
          break;
        }
      }

      if(!f) return "";

      str += ` WHERE ${w} `;
    }

    return str;
  },

  // 搜索表数据
  selectTableData(connection, data) {

    let str = ` SELECT `;

    // 设置搜索字段
    str += ` ${data.data.column} `;

    // 设置搜索表名
    str += ` FROM ${data.tableName} `;

    // 设置搜索条件
    str += ` WHERE ${data.data.where} `;

    // 设置返回记录数，默认是0
    str += ` LIMIT ${data.data.limit ? data.data.limit : 10} `;

    // 设置返回记录条数，默认10条
    str += ` OFFSET ${data.data.offset ? data.data.offset : 0} `;

    str += ` ; `;

    return str;
  },

}
